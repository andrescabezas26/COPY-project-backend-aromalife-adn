name: CI/CD - SonarQube + Trivy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: read

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Job 1: Trivy Security Scan
  # ============================================
  trivy-security-scan:
    name: ðŸ”’ Trivy Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Run Trivy scanner (Table format)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

      - name: ðŸ› Debug project structure
        run: |
          echo "ðŸ“ Project structure:"
          ls -la
          echo ""
          echo "ðŸ“¦ Package files:"
          find . -name "package*.json" -o -name "yarn.lock" -o -name "pnpm-lock.yaml" | head -20

      - name: ðŸ” Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: false
          vuln-type: "os,library"

      - name: ðŸ› Validate SARIF file
        if: always()
        run: |
          if [ -f trivy-results.sarif ]; then
            echo "âœ… SARIF file exists"
            SIZE=$(stat -c%s trivy-results.sarif 2>/dev/null || stat -f%z trivy-results.sarif)
            echo "ðŸ“Š File size: $SIZE bytes"
            
            if [ $SIZE -lt 100 ]; then
              echo "âš ï¸ WARNING: SARIF file is very small, might be empty"
            fi
            
            echo "ðŸ” SARIF content preview:"
            head -n 50 trivy-results.sarif
          else
            echo "âŒ SARIF file not found!"
            exit 1
          fi

      - name: ðŸ“Š Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy-filesystem-scan"
          wait-for-processing: true
          checkout_path: ${{ github.workspace }}

      - name: ðŸ” Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "json"
          output: "trivy-report.json"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: ðŸ“¤ Upload Trivy JSON report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-report
          path: trivy-report.json
          retention-days: 30

  # ============================================
  # Job 2: Tests y Coverage
  # ============================================
  test-and-coverage:
    name: ðŸ§ª Tests & Coverage
    runs-on: ubuntu-latest
    needs: trivy-security-scan

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸ§ª Run tests with coverage
        run: npm run test:cov
        continue-on-error: true

      - name: ðŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # ============================================
  # Job 3: SonarQube Analysis
  # ============================================
  sonarqube-analysis:
    name: ðŸ“Š SonarQube Analysis
    runs-on: ubuntu-latest
    needs: test-and-coverage

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸ§ª Run tests with coverage
        run: npm run test:cov
        continue-on-error: true

      - name: ðŸ“Š SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=aromalife-backend
            -Dsonar.sources=src
            -Dsonar.tests=test
            -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.exclusions=**/node_modules/**,**/*.spec.ts,**/test/**,**/dist/**,**/coverage/**,**/scripts/**,**/postgres-data/**,**/pgadmin-data/**,**/terraform/**

      - name: âœ… SonarQube Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # ============================================
  # Job 4: Security Report Summary
  # ============================================
  security-report:
    name: ðŸ“‹ Security Report Summary
    runs-on: ubuntu-latest
    needs: [trivy-security-scan, sonarqube-analysis]
    if: always()

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Trivy report
        uses: actions/download-artifact@v4
        with:
          name: trivy-security-report
        continue-on-error: true

      - name: ðŸ“Š Generate Security Summary
        run: |
          echo "# ðŸ”’ Security & Quality Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“… Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Analysis Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trivy Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SonarQube Code Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Reports Available" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Tab:** GitHub Security > Code scanning > Trivy" >> $GITHUB_STEP_SUMMARY
          echo "- **SonarQube:** ${{ secrets.SONAR_HOST_URL }}/dashboard?id=aromalife-backend" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts:** Download detailed reports below" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f trivy-report.json ]; then
            echo "## ðŸ” Trivy Findings Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat trivy-report.json | head -n 20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
